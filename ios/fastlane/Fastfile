require_relative '../../fastlane/Fasthelper'
require 'dotenv'

env_file = '../../fastlane/.env'
if File.exist?(env_file)
  Dotenv.load(env_file)
  UI.message('Loaded common .env configuration')
else
  UI.message('No common .env file found, skipping...')
end

default_platform(:ios)

def upload_to_firebase_distribution(app_id:, tester_groups:, service_account_name:)
  service_account_path = SharedFastlane.service_account_path(file_name: service_account_name, fastfile_dir: __dir__)
  SharedFastlane.validate_file_exists(
    file_path: service_account_path,
    file_name: 'Firebase service account credentials file'
  )

  firebase_app_distribution(
    app: app_id,
    groups: tester_groups,
    service_credentials_file: service_account_path
  )
end

def maybe_apply_flavor_config(flavor)
  env_file = File.join(__dir__, ".env.#{flavor}")
  if File.exist?(env_file)
    Dotenv.overload(env_file)
    UI.message("Loaded configuration for flavor: #{flavor}")
  else
    UI.message("No environment file found for flavor: #{flavor}, skipping...")
  end
end

def maybe_apply_common_flavor_config(flavor)
  project_root = SharedFastlane.project_root(fastfile_dir: __dir__)
  common_env_file = File.join(project_root, 'fastlane', ".env.#{flavor}")
  if File.exist?(common_env_file)
    Dotenv.overload(common_env_file)
    UI.message("Loaded common configuration for flavor: #{flavor}")
  else
    UI.message("No common environment file found for flavor: #{flavor}, skipping...")
  end
end

platform :ios do
  lane :flutter_clean do
    UI.message('Cleaning Flutter project...')
    sh 'flutter clean'
    UI.success('Flutter project cleaned successfully! ðŸŽ‰')
  end

  lane :build_ios_no_codesign do
    flutter_clean

    UI.message('Building iOS release without code signing...')
    sh('flutter pub get')
    sh('bundle exec pod install')
    sh 'flutter build ios --release --no-codesign'
    UI.success('iOS release built successfully without code signing! ðŸŽ‰')
  end

  lane :distribute_to_firebase do |options|
    flavor = options[:flavor] || 'dev'
    maybe_apply_flavor_config(flavor)
    maybe_apply_common_flavor_config(flavor)

    setup_ci

    build_ios_no_codesign

    app_store_key = app_store_connect_api_key(
      key_id: ENV.fetch('APP_STORE_CONNECT_API_KEY_ID'),
      issuer_id: ENV.fetch('APP_STORE_CONNECT_API_ISSUER_ID'),
      key_filepath: 'fastlane/AuthKey.p8'
    )

    sync_code_signing(
      app_identifier: ENV.fetch('BUNDLE_ID'),
      api_key: app_store_key,
      type: 'adhoc',
      readonly: true
    )

    if is_ci?
      unlock_keychain(
        path: ENV.fetch('MATCH_KEYCHAIN_NAME', nil),
        password: ENV.fetch('MATCH_KEYCHAIN_PASSWORD', nil)
      )
    end

    if is_ci?
      update_code_signing_settings(
        use_automatic_signing: false,
        path: 'Runner.xcodeproj',
        team_id: ENV.fetch('APPLE_DEVELOPER_TEAM_ID'),
        bundle_identifier: ENV.fetch('BUNDLE_ID'),
        profile_name: "match AdHoc #{ENV.fetch('BUNDLE_ID')}",
        code_sign_identity: 'Apple Distribution'
      )
    end

    build_app(
      scheme: 'Runner',
      export_method: 'ad-hoc',
      output_directory: './build'
    )

    upload_to_firebase_distribution(
      app_id: ENV.fetch('FIREBASE_APP_ID'),
      tester_groups: ENV.fetch('TESTER_GROUP'),
      service_account_name: ENV.fetch('SERVICE_ACCOUNT_NAME')
    )

    upload_symbols_to_crashlytics(
      dsym_path: lane_context[SharedValues::DSYM_OUTPUT_PATH]
    )
  end
end
